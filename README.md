# Парсер объявлений с kolesa.kz

Небольшой скрипт для выгрузки объявлений о продаже автомобилей с [kolesa.kz](https://kolesa.kz) в CSV-файл. Скрипт обходит пагинацию, аккуратно делает паузы между запросами и сохраняет результаты в `cars_kolesa.csv`.

## Состав проекта
- `parser.py` — основной парсер: HTTP-сессия с ретраями, определение страниц-списков, разбор карточек в старой и новой вёрстке, сохранение CSV.
- `requirements.txt` — версии зависимостей.
- `cars_kolesa.csv` — итоговая выгрузка (колонки: `name`, `price`, `price_raw`, `desc`, `link`).
- `cars_kolesa_partial.csv` — промежуточное сохранение (обновляется каждые 20 страниц).
- `kolesa-data-preprocessing.ipynb` — пример предобработки собранных данных.
- `test.py` — короткий пример чтения CSV через pandas.

## Быстрый старт
```bash
python -m venv .venv
# Windows
.venv\Scripts\activate
pip install -r requirements.txt
python parser.py
```
После выполнения появится (или обновится) файл `cars_kolesa.csv` с полным набором строк.

## Как работает парсер
- Отправляет GET-запросы к `https://kolesa.kz/cars/` с заголовками, похожими на обычный браузер.
- Автоматически повторяет запросы при 429/5xx (до 6 попыток) и добавляет случайные задержки.
- Ограничивает пагинацию константой `MAX_PAGES` (по умолчанию 200).
- Прекращает работу, если подряд встретилось `STOP_AFTER_BLOCKS` страниц, не похожих на выдачу (например, при блокировке).
- Каждые 20 страниц сохраняет промежуточный файл `cars_kolesa_partial.csv`.

Настройки задержек, лимита страниц и чувствительности к блокировкам находятся в начале `parser.py` и легко меняются.

## Формат данных
Каждая строка CSV содержит:
- `name` — название объявления.
- `price` — цена в числовом виде (если удалось извлечь).
- `price_raw` — исходная строка с ценой.
- `desc` — краткое описание/характеристики.
- `link` — прямая ссылка на объявление.

Пример проверки данных:
```bash
python test.py
```

## Советы по запуску и отладке
- При подозрении на блокировки посмотрите сохранённые `debug_page_*.html` (создаются при ошибках распознавания страницы).
- Если сайт изменил вёрстку, обновите CSS-селекторы в функциях `parse_cards_new` и `parse_cards_old`.
- Уважайте правила сайта: не снижайте задержки, не повышайте параллелизм и не используйте скрипт в обход ограничений `robots.txt`.
